# ================== IMPORTY ==================
import discord
from discord.ext import commands
from discord import app_commands
from discord.ui import View, Button, Select
import yt_dlp
import asyncio
import datetime, os

# ================== KONFIG ==================
GUILD_ID = 1378797704133742774
VERIFIED_ROLE_ID = 1437464785334833253
TICKET_CATEGORY_ID = 1442217936768209188
STAFF_ROLE_ID = 1379102924617027655

LOG_PATH = "/home/iseeyou/Pulpit/Logi/logi.md"

OSTATNIA_LITERA_ID = 1234567890
OSOBA_PONIZEJ_ID = 1234567890
LICZENIA_ID = 1234567890

# ================== INTENTY ==================
intents = discord.Intents.all()  # <- wszystkie permisje
bot = commands.Bot(command_prefix="!", intents=intents)

# ================== LOGI ==================
def log_to_file(text: str):
    ts = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    os.makedirs(os.path.dirname(LOG_PATH), exist_ok=True)
    with open(LOG_PATH, "a", encoding="utf-8") as f:
        f.write(f"- `{ts}` {text}\n")

# ================== GRY â€“ STAN ==================
last_word = None
last_number = 0
last_user_game = {"litera": None, "liczenia": None}

# ================== WERYFIKACJA / MENU / MAX / TICKET ==================
class VerifyView(View):
    @discord.ui.button(label="âœ… Zweryfikuj siÄ™", style=discord.ButtonStyle.green)
    async def verify(self, interaction: discord.Interaction, button: Button):
        role = interaction.guild.get_role(VERIFIED_ROLE_ID)
        if role:
            await interaction.user.add_roles(role)
            await interaction.response.send_message("âœ… Zweryfikowano!", ephemeral=True)
        else:
            await interaction.response.send_message("âŒ Brak roli", ephemeral=True)

class TicketActionView(View):
    def __init__(self, channel):
        super().__init__()
        self.channel = channel

    @discord.ui.button(label="ðŸ—‘ï¸ Zamknij", style=discord.ButtonStyle.red)
    async def close(self, interaction: discord.Interaction, button: Button):
        await interaction.response.send_message("Ticket zamkniÄ™ty", ephemeral=True)
        await self.channel.delete()

class TicketSelect(Select):
    def __init__(self):
        options = [
            discord.SelectOption(label="Support"),
            discord.SelectOption(label="Skarga"),
            discord.SelectOption(label="Propozycja")
        ]
        super().__init__(placeholder="Wybierz typ ticketu", options=options)

    async def callback(self, interaction: discord.Interaction):
        guild = interaction.guild
        category = guild.get_channel(TICKET_CATEGORY_ID)
        overwrites = {
            guild.default_role: discord.PermissionOverwrite(view_channel=False),
            interaction.user: discord.PermissionOverwrite(view_channel=True),
            guild.get_role(STAFF_ROLE_ID): discord.PermissionOverwrite(view_channel=True)
        }
        channel = await guild.create_text_channel(
            f"ticket-{interaction.user.name}".lower(),
            category=category,
            overwrites=overwrites
        )
        await channel.send(
            f"ðŸŽ« {interaction.user.mention} utworzyÅ‚ ticket **{self.values[0]}**",
            view=TicketActionView(channel)
        )
        await interaction.response.send_message(f"âœ… Utworzono {channel.mention}", ephemeral=True)

class TicketView(View):
    def __init__(self):
        super().__init__()
        self.add_item(TicketSelect())

class MenuView(View):
    @discord.ui.button(label="ðŸŽ« Tickety", style=discord.ButtonStyle.green)
    async def t(self, i: discord.Interaction, b: Button):
        await i.response.send_message("TwÃ³rz tickety komendÄ… /ticket", ephemeral=True)
    @discord.ui.button(label="ðŸ” Weryfikacja", style=discord.ButtonStyle.gray)
    async def v(self, i: discord.Interaction, b: Button):
        await i.response.send_message("Kliknij panel weryfikacji", ephemeral=True)

DYNAMIC_CHANNELS = {}

# ================== SLASH COMMANDY ==================
@bot.tree.command(name="ping", description="SprawdÅº czy bot Å¼yje", guild=discord.Object(id=GUILD_ID))
async def ping(interaction: discord.Interaction):
    await interaction.response.send_message(f"ðŸ“ Pong! `{round(bot.latency*1000)} ms`", ephemeral=True)
    log_to_file(f"Slash /ping uÅ¼yty przez {interaction.user} na {interaction.channel}")

@bot.tree.command(name="weryfikacja", guild=discord.Object(id=GUILD_ID))
@app_commands.checks.has_permissions(administrator=True)
async def weryfikacja(interaction: discord.Interaction):
    await interaction.channel.send("ðŸ” Kliknij aby siÄ™ zweryfikowaÄ‡:", view=VerifyView())
    await interaction.response.send_message("âœ… Panel wysÅ‚any", ephemeral=True)
    log_to_file(f"Slash /weryfikacja uÅ¼yty przez {interaction.user} na {interaction.channel}")

@bot.tree.command(name="ticket", guild=discord.Object(id=GUILD_ID))
async def ticket(interaction: discord.Interaction):
    await interaction.response.send_message("ðŸ“‚ Wybierz typ ticketu:", view=TicketView(), ephemeral=True)
    log_to_file(f"Slash /ticket uÅ¼yty przez {interaction.user} na {interaction.channel}")

@bot.tree.command(name="menu", guild=discord.Object(id=GUILD_ID))
async def menu(interaction: discord.Interaction):
    await interaction.response.send_message("ðŸ“Œ Menu serwera:", view=MenuView(), ephemeral=True)
    log_to_file(f"Slash /menu uÅ¼yty przez {interaction.user} na {interaction.channel}")

# ================== VOICE & STATUS LOGI ==================
@bot.event
async def on_voice_state_update(member, before, after):
    if before.channel != after.channel:
        if after.channel:
            log_to_file(f"{member} doÅ‚Ä…czyÅ‚ do VC {after.channel}")
        if before.channel:
            log_to_file(f"{member} opuÅ›ciÅ‚ VC {before.channel}")
    # MAX dynamiczny
    if after.channel and after.channel.id in DYNAMIC_CHANNELS:
        limit = DYNAMIC_CHANNELS[after.channel.id]
        vc = await member.guild.create_voice_channel(
            f"{member.display_name}", user_limit=limit
        )
        await member.move_to(vc)
    if before.channel and before.channel.id in DYNAMIC_CHANNELS:
        if len(before.channel.members) == 0:
            await before.channel.delete()

@bot.event
async def on_presence_update(before, after):
    if before.status != after.status:
        log_to_file(f"{after} zmieniÅ‚ status z `{before.status}` na `{after.status}`")

# ================== START ==================
def start_bot(token):
    bot.run(token)
